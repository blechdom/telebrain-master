"use strict";(function(e){var t=e.livetime=e.livetime||{};t.version="0.0.6",t.localTimeOffset=null;var n=t.options=t.options||{};n.datetimeSelector="[datetime]",n.datetimeAttribute="datetime",n.durationAttribute="data-duration",n.dateLabelSelector="[data-time-label]",n.triggerRefreshComplete=!0,n.serverTimeUrl=null,n.formats=n.formats||{},n.formats._default=n.formats._default||[[-28512e3,"yyyy MMMM d at H:mm"],[-2592e3,"in td_M months d_d days, MMMM d at H:mm"],[-604800,"in td_d days, MMMM d at H:mm"],[-172800,"next eeee, MMMM d at H:mm"],[-7200,"in td_h hours d_m minutes, today at H:mm"],[-300,"in td_m minutes, at H:mm:ss"],[-60,"in td_m minutes d_s seconds, at H:mm:ss"],[0,"in td_s seconds, at H:mm:ss"],[60,"td_s seconds ago, at H:mm:ss"],[300,"td_m minutes d_s seconds ago, at H:mm:ss"],[7200,"td_m minutes ago, at H:mm:ss"],[172800,"td_h hours d_m minutes ago, today at H:mm"],[604800,"last eeee, MMMM d at H:mm"],[2592e3,"MMMM d at H:mm"],["yyyy MMMM d at H:mm"]],n.formats.seconds=n.formats.seconds||[[0,"in td_hh:d_mm:d_ss"],["td_hh:d_mm:d_ss ago"]],n.formats.milliseconds=n.formats.milliseconds||[[0,"in td_hh:d_mm:d_ss.d_fff"],["td_hh:d_mm:d_ss.d_fff ago"]],n.formats.humanized=n.formats.humanized||[[-31104e3,"MMMM d, yyyy"],[-518400,"MMMM d at h:mm tt"],[-172800,"eeee at h:mm tt"],[-86400,"Tomorrow at h:mm tt"],[-7200,"in td_h hours"],[-3600,"in about an hour"],[-120,"in td_m minutes"],[-60,"in about a minute"],[0,"in a few seconds"],[60,"a few seconds ago"],[120,"about a minute ago"],[3600,"td_m minutes ago"],[7200,"about an hour ago"],[86400,"td_h hours ago"],[172800,"Yesterday at h:mm tt"],[518400,"eeee at h:mm tt"],[31104e3,"MMMM d at h:mm tt"],["MMMM d, yyyy"]],n.formats.fulldate=n.formats.fulldate||"eee MMM d yyyy at h:mm:ss tt",n.formats.shortdate=n.formats.shortdate||"MMM d yyyy",n.formats._default_tooltip=n.formats.fulldate,n.formats._in=n.formats._in||[[0,"in"],[""]],n.formats.remaining=n.formats.remaining||[[0,"remaining"],[""]],n.formats.ago=n.formats.ago||[[0,""],["ago"]],n.formats.elapsed=n.formats.elapsed||[[0,""],["elapsed"]];var r=function(e,t){if(t<2)return e;var n=e+"";while(n.length<t)n="0"+n;return n},i={y:315576e5,M:2592e6,w:6048e5,d:864e5,e:864e5,h:36e5,m:6e4,s:1e3,f:1},s={M:"y",w:"M",d:"M",e:"w",h:"d",m:"h",s:"m",f:"s"},o={M:["January","February","March","April","May","June","July","August","September","October","November","December"],e:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},u=window.console&&typeof window.console.log=="function"?function(){console.log.call(console,arguments)}:function(){},a=/^(\d{4})\-(\d{2})\-(\d{2})(?:[ T](\d{2}):(\d{2}):(\d{2})(?:\.(\d+))?(.*))?$/,f=/^([+\-]?)(\d{2}):(\d{2})$/,l=[function(e){return new Date(e)},function(e){return new Date(e.slice(10,11)!==" "?e:e.slice(0,10)+"T"+e.slice(11))},function(e){var t=a.exec(e),n=0;if(t){if(typeof t[4]=="undefined"||t[4]===""||t[4]===null)return new Date(Date.UTC(parseInt(t[1]),parseInt(t[2])-1,parseInt(t[3])));if(t[8]&&t[8]!=="Z"&&t[8]!=="GMT"&&t[8]!=="UTC"){var r=f.exec(t[8]);if(!r)throw new Error("invalid datetime format");n=(r[0]==="-"?-1:1)*(parseInt(r[2])*60+parseInt(r[3]))*6e4}return new Date(Date.UTC(parseInt(t[1]),parseInt(t[2])-1,parseInt(t[3]),parseInt(t[4]),parseInt(t[5]),parseInt(t[6]),t[7]?parseInt(t[7]):0)+n)}throw new Error("invalid datetime format")}],c=l[l.length-1],h=function(){var e=!1,t=0,n={};n["2012-12-04 23:59:59.999Z"]=Date.UTC(2012,11,4,23,59,59,999),n["2012-01-31T00:54:02"]=Date.UTC(2012,0,31,0,54,2),n["2012-12-22T18:30:00-03:00"]=Date.UTC(2012,11,22,21,30,0),n["1987-02-28"]=Date.UTC(1987,1,28);while(!e&&t<l.length){try{e=!0;for(var r in n)if(n[r]!==l[t](r).getTime()){e=!1;break}e&&(c=l[t])}catch(i){e=!1}e||t++}};h(),t.parseDate=function(e){if(typeof str=="number"||/^[0-9]+$/.test(e))return new Date(parseInt(e,10));try{return c(e)}catch(t){throw new Error('error parsing datetime "'+e+'": '+t)}},t.now=function(){t.localTimeOffset===null&&t.getLocalTimeOffset();var e=t.localTimeOffset||0,n=new Date,r=n.getTime()-n.getTimezoneOffset()*60*1e3+e;return r},t.getLocalTimeOffset=function(){var r,i,s,o,a;if(!n.serverTimeUrl){t.localTimeOffset=0;return}if(!t.localTimeOffsetRequested&&(typeof t.localTimeOffset=="undefined"||t.localTimeOffset===null)){t.localTimeOffsetRequested=!0,t.localTimeOffset=0;var f=null;if(window.sessionStorage)f=window.sessionStorage.getItem("jlivetime-localtimeoffset");else try{f=/localtimeoffset=([0-9]+)[^0-9]?/i.exec(document.cookie)[1]}catch(l){f=null}typeof f!="undefined"&&f!==null?t.localTimeOffset=parseInt(f,10):e.ajax({url:n.serverTimeUrl,method:"jsonp",cache:!1,success:function(e,n,r){i=new Date,s=r.getResponseHeader("Date");var o=new Date(s);t.localTimeOffset=i.getTime()-o.getTime(),window.sessionStorage?window.sessionStorage.setItem("jlivetime-localtimeoffset",t.localTimeOffset):document.cookie="localtimeoffset="+t.localTimeOffset,t.localTimeOffset>1e4&&u("WARNING: local time offset is "+Math.round(t.localTimeOffset/1e3)+"s")}})}},t.millisecondsFromNow=function(e){var n=e;return e instanceof Date&&(n=e.getTime()+e.getTimezoneOffset()*60*1e3),t.now()-n},t.refresh=function(r){var i=(new Date).getTime(),s=e(r);s.addClass("jlivetime-active");var o=s.data("jlivetime-timeout");typeof o!="undefined"&&clearTimeout(o);var a=6e4,f=s.find(n.datetimeSelector);s.is(n.datetimeSelector)&&(f=f.add(s)),f.each(function(){var r=6e4,s=e(this),o=s.attr(n.datetimeAttribute);if(o){var f;try{if(o.indexOf("-")>0){var l=t.parseDate(o);f=l.getTime()-l.getTimezoneOffset()*6e4}else f=parseInt(o,10)}catch(c){u("error parsing timestamp: "+c),f=0}if(f>0){var h=t.millisecondsFromNow(f),p=0;try{var d=s.attr(n.durationAttribute);d&&(p=parseInt(d,10))}catch(c){u("error parsing duration: "+c),p=0}s.data("time-diff",h);var v=s.find(n.dateLabelSelector);s.is(n.dateLabelSelector)&&(v=v.add(s)),v.each(function(){var s=e(this),o=!1,u=!1,a=t.format(f,h,p,s.data("time-label")||"#_default");a.value!==null&&typeof a.value!="undefined"&&s.html()!==a.value&&(s.html(a.value),o=!0),a.nextRefreshMs&&(r=Math.min(r,a.nextRefreshMs)),typeof s.data("time-tooltip")!="undefined"&&(a=t.format(f,h,p,s.data("time-tooltip")||"#_default_tooltip"),a.value!==null&&typeof a.value!="undefined"&&s.attr("title")!==a.value&&(s.attr("title",a.value),typeof s.attr("data-original-title")!="undefined"&&s.attr("data-original-title",a.value),u=!0),a.nextRefreshMs&&(r=Math.min(r,a.nextRefreshMs))),(o||u)&&n.triggerRefreshComplete&&s.trigger("refreshComplete",{nextRefreshMs:r,htmlChanged:o,tooltipChanged:u,refreshElapsedTime:(new Date).getTime()-i})}),h<0&&(r=Math.min(r,-h)),a=Math.min(a,r)}}s.data("jlivetime-nextrefresh",(new Date).getTime()+a)}),a=Math.max(a,65),s.data("jlivetime-timeout",setTimeout(function(){t.refresh(r)},a))},t.disable=function(t){var n=e(t),r=n.data("jlivetime-timeout");typeof r!="undefined"&&clearTimeout(r),n.removeClass("jlivetime-active")},t.formatPart=function(e,t,n){if(n==="[]")return{value:""};var u=/^(t?d_)?(([yMdewHhmsft])\3*)$/.exec(n);if(u)if(!u[1]){var a=new Date(e+(new Date).getTimezoneOffset()*60*1e3);switch(u[3]){case"y":return{value:r(a.getFullYear(),u[2].length)};case"M":var f=u[2].length>2?o.M[a.getMonth()]:r(a.getMonth()+1,u[2].length);return u[2].length===3&&(f=f.slice(0,3)),{value:f};case"w":return{value:r(Math.floor(a.getDate()/7)+1,u[2].length)};case"d":return{value:r(a.getDate(),u[2].length)};case"e":var l=u[2].length>1?o.e[a.getDay()]:a.getDay()+1;return u[2].length>1&&u[2].length<=3&&(l=l.slice(0,u[2].length)),{value:l};case"h":return{value:r(a.getHours()>12?a.getHours()-12:a.getHours(),u[2].length)};case"H":return{value:r(a.getHours(),u[2].length)};case"m":return{value:r(a.getMinutes(),u[2].length)};case"s":return{value:r(a.getSeconds(),u[2].length)};case"f":return{value:r(a.getMilliseconds(),u[2].length)};case"t":var c=a.getHours()>=12?"pm":"am";return{value:u[2].length>1?c:c.slice(0,1)}}}else{var h=i[u[3]];if(h){var p;p=Math.max(65,t>0?h-t%h:-t%h);if(u[1]=="td_")return{value:r(Math.floor(Math.abs(t/h)),u[2].length),nextRefreshMs:p};if(u[1]=="d_"){var d=i[s[u[3]]];return{value:r(Math.floor(Math.abs(d?t%d:t)/h),u[2].length),nextRefreshMs:p}}}}return{value:n}},t.getFormatExpression=function(e,r,i,s){var o=6e4,a=s;if(a===null||a==="null")a=null;else{if(typeof a=="string"&&a.slice(0,1)==="#"){a=n.formats[a.slice(1)];if(typeof a=="undefined")throw new Error("time format not found: "+s)}if(a instanceof Array){var f=a.length;for(var l=0;l<f;l++){if(a[l].length===1){a=a[l][0];break}var c=a[l][0];if(typeof c=="string"){if(c.slice(0,3)==="end")if(c.length>3)try{c=i+parseInt(c.slice(3),10)*1e3}catch(h){u("error parsing format range: "+h)}else c=i}else c*=1e3;if(c>=r){o=Math.min(o,c-r),a=a[l][1];break}}a instanceof Array&&(a="<unknown>")}if(typeof a=="string"&&a.slice(0,1)==="#")return t.getFormatExpression(e,r,i,a)}return{expression:a,nextRefreshMs:o}},t.format=function(e,n,r,i){var s=/\[?([a-z_]+)\]?/gim,o=[],u=0,a=t.getFormatExpression(e,n,r,i);if(a.expression===null)return a;var f=s.exec(a.expression);while(f){o.push(a.expression.slice(u,f.index));if(f[0].length!=f[1].length)o.push(f[1]);else{var l=f[0],c=0;l.slice(0,4)==="end_"&&(l=l.slice(4),c=r);var h=t.formatPart(e+c,n-c,l);o.push(h.value),h.nextRefreshMs&&(a.nextRefreshMs=Math.min(a.nextRefreshMs,h.nextRefreshMs))}u=f.index+f[0].length,f=s.exec(a.expression)}return o.push(a.expression.slice(u)),a.value=o.join(""),a},e.fn.livetime=function(n){this.each(function(){var r=e(this);if(!r.is(".jlivetime-active")){var i=e(this).parent(".jlivetime-active");i.length&&(r=i)}n===!1?t.disable(r.get(0)):t.refresh(r.get(0))})}})(jQuery);